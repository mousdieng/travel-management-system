<div class="container mx-auto px-4 py-8">
  @if (loading()) {
    <div class="flex justify-center items-center h-64">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>
  }

  @if (error()) {
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
      {{ error() }}
    </div>
  }

  @if (stats() && !loading()) {
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">{{ stats()?.title }}</h1>
          <p class="text-gray-600 mt-2">{{ stats()?.destination }} • {{ stats()?.category }}</p>
        </div>
        <a routerLink="/manager/travels" class="text-indigo-600 hover:text-indigo-800">
          ← Back to Travels
        </a>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <nav class="flex space-x-8">
        <button
          (click)="setTab('overview')"
          [class]="selectedTab() === 'overview' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-4 px-1 border-b-2 font-medium text-sm transition">
          Overview
        </button>
        <button
          (click)="setTab('subscribers')"
          [class]="selectedTab() === 'subscribers' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-4 px-1 border-b-2 font-medium text-sm transition">
          Subscribers ({{ stats()?.totalSubscribers }})
        </button>
        <button
          (click)="setTab('feedbacks')"
          [class]="selectedTab() === 'feedbacks' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-4 px-1 border-b-2 font-medium text-sm transition">
          Feedbacks ({{ stats()?.totalFeedbacks }})
        </button>
      </nav>
    </div>

    <!-- Overview Tab -->
    @if (selectedTab() === 'overview') {
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm font-medium text-gray-600">Total Revenue</p>
          <p class="text-2xl font-bold text-green-600 mt-1">{{ formatCurrency(stats()?.totalRevenue || 0) }}</p>
          <p class="text-xs text-gray-500 mt-1">Expected: {{ formatCurrency(stats()?.expectedRevenue || 0) }}</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm font-medium text-gray-600">Total Subscribers</p>
          <p class="text-2xl font-bold text-indigo-600 mt-1">{{ stats()?.totalSubscribers }}</p>
          <p class="text-xs text-green-600 mt-1">{{ stats()?.activeSubscribers }} active</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm font-medium text-gray-600">Occupancy Rate</p>
          <p class="text-2xl font-bold text-blue-600 mt-1">{{ stats()?.occupancyRate?.toFixed(1) }}%</p>
          <p class="text-xs text-gray-500 mt-1">{{ stats()?.cancelledSubscribers }} cancelled</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm font-medium text-gray-600">Average Rating</p>
          <p class="text-2xl font-bold text-yellow-600 mt-1">{{ stats()?.averageRating?.toFixed(1) || 'N/A' }}</p>
          <div class="flex items-center mt-1">
            @for (star of getRatingStars(stats()?.averageRating || 0); track $index) {
              <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
              </svg>
            }
          </div>
        </div>
      </div>

      <!-- Financial & Subscriber Stats -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Financial Stats -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Financial Statistics</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center pb-2 border-b">
              <span class="text-gray-600">Total Revenue</span>
              <span class="font-bold text-green-600">{{ formatCurrency(stats()?.totalRevenue || 0) }}</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b">
              <span class="text-gray-600">Expected Revenue</span>
              <span class="font-medium text-gray-600">{{ formatCurrency(stats()?.expectedRevenue || 0) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Avg per Subscriber</span>
              <span class="font-medium text-blue-600">{{ formatCurrency(stats()?.averageRevenuePerSubscriber || 0) }}</span>
            </div>
          </div>
        </div>

        <!-- Subscription Stats -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Subscription Statistics</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center pb-2 border-b">
              <span class="text-gray-600">Total Subscribers</span>
              <span class="font-bold text-gray-900">{{ stats()?.totalSubscribers }}</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b">
              <span class="text-gray-600">Active</span>
              <span class="font-medium text-green-600">{{ stats()?.activeSubscribers }}</span>
            </div>
            <div class="flex justify-between items-center pb-2 border-b">
              <span class="text-gray-600">Cancelled</span>
              <span class="font-medium text-red-600">{{ stats()?.cancelledSubscribers }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Completed</span>
              <span class="font-medium text-blue-600">{{ stats()?.completedSubscribers }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback Distribution -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Feedback Distribution</h3>
        <div class="space-y-3">
          @for (stars of [5, 4, 3, 2, 1]; track stars) {
            <div class="flex items-center">
              <div class="flex items-center w-20">
                <span class="text-sm font-medium text-gray-700">{{ stars }}</span>
                <svg class="w-4 h-4 text-yellow-400 ml-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
              </div>
              <div class="flex-1 mx-4">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  @if (stars === 5) {
                    <div class="bg-green-500 h-2.5 rounded-full" [style.width.%]="getStarPercentage(stats()?.fiveStarCount || 0, stats()?.totalFeedbacks || 0)"></div>
                  } @else if (stars === 4) {
                    <div class="bg-blue-500 h-2.5 rounded-full" [style.width.%]="getStarPercentage(stats()?.fourStarCount || 0, stats()?.totalFeedbacks || 0)"></div>
                  } @else if (stars === 3) {
                    <div class="bg-yellow-500 h-2.5 rounded-full" [style.width.%]="getStarPercentage(stats()?.threeStarCount || 0, stats()?.totalFeedbacks || 0)"></div>
                  } @else if (stars === 2) {
                    <div class="bg-orange-500 h-2.5 rounded-full" [style.width.%]="getStarPercentage(stats()?.twoStarCount || 0, stats()?.totalFeedbacks || 0)"></div>
                  } @else {
                    <div class="bg-red-500 h-2.5 rounded-full" [style.width.%]="getStarPercentage(stats()?.oneStarCount || 0, stats()?.totalFeedbacks || 0)"></div>
                  }
                </div>
              </div>
              <div class="w-16 text-right">
                @if (stars === 5) {
                  <span class="text-sm font-medium text-gray-700">{{ stats()?.fiveStarCount || 0 }}</span>
                } @else if (stars === 4) {
                  <span class="text-sm font-medium text-gray-700">{{ stats()?.fourStarCount || 0 }}</span>
                } @else if (stars === 3) {
                  <span class="text-sm font-medium text-gray-700">{{ stats()?.threeStarCount || 0 }}</span>
                } @else if (stars === 2) {
                  <span class="text-sm font-medium text-gray-700">{{ stats()?.twoStarCount || 0 }}</span>
                } @else {
                  <span class="text-sm font-medium text-gray-700">{{ stats()?.oneStarCount || 0 }}</span>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Subscribers Tab -->
    @if (selectedTab() === 'subscribers') {
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Traveler</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statistics</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subscribed At</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              @for (subscriber of stats()?.subscribers; track subscriber.subscriptionId) {
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                      <div class="text-sm font-medium text-gray-900">{{ subscriber.travelerName }}</div>
                      <div class="text-sm text-gray-500">{{ subscriber.travelerEmail }}</div>
                      @if (subscriber.travelerPhone) {
                        <div class="text-sm text-gray-500">{{ subscriber.travelerPhone }}</div>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span [class]="'px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ' + getStatusBadge(subscriber.status)">
                      {{ subscriber.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <div>Total: {{ subscriber.totalSubscriptions }}</div>
                    <div>Completed: {{ subscriber.completedTravels }}</div>
                    <div class="flex items-center">
                      <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                      </svg>
                      {{ subscriber.averageRating ? subscriber.averageRating.toFixed(1) : 'N/A' }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span [class]="'px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ' + getPaymentBadge(subscriber.paymentStatus)">
                      {{ subscriber.paymentStatus }}
                    </span>
                    @if (subscriber.amountPaid) {
                      <div class="text-sm text-gray-600 mt-1">{{ formatCurrency(subscriber.amountPaid) }}</div>
                    }
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {{ subscriber.subscribedAt | date:'MMM d, y' }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    @if (subscriber.status === 'ACTIVE') {
                      <button
                        (click)="removeSubscriber(subscriber.subscriptionId)"
                        class="text-red-600 hover:text-red-900">
                        Remove
                      </button>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- Feedbacks Tab -->
    @if (selectedTab() === 'feedbacks') {
      <div class="space-y-4">
        @if (stats() && stats()!.recentFeedbacks && stats()!.recentFeedbacks.length > 0) {
          @for (feedback of stats()?.recentFeedbacks; track feedback.id) {
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <p class="font-semibold text-gray-900">{{ feedback.travelerName }}</p>
                  <p class="text-sm text-gray-500">{{ feedback.createdAt | date:'MMM d, y' }}</p>
                </div>
                <div class="flex items-center">
                  <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                  </svg>
                  <span class="ml-1 font-medium">{{ feedback.rating }}</span>
                </div>
              </div>
              <p class="text-gray-700">{{ feedback.comment }}</p>
            </div>
          }
        } @else {
          <div class="text-center py-12 bg-white rounded-lg shadow">
            <p class="text-gray-500">No feedbacks yet</p>
          </div>
        }
      </div>
    }
  }
</div>
