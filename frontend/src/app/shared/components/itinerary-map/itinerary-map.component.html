<div class="itinerary-map-container">
  <!-- Map Section -->
  <div class="map-section">
    <google-map
      [center]="mapCenter"
      [zoom]="mapZoom"
      [options]="mapOptions"
      width="100%"
      height="600px">

      <!-- Markers for each stop -->
      <map-marker
        *ngFor="let marker of markers; let i = index"
        [position]="marker"
        [options]="{
          draggable: !readonly,
          icon: getMarkerIcon(i)
        }"
        [title]="stops.at(i)?.value?.name || 'Stop ' + (i + 1)">
      </map-marker>

      <!-- Route directions -->
      <map-directions-renderer
        *ngIf="directionsResults"
        [directions]="directionsResults"
        [options]="{
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: '#4285F4',
            strokeWeight: 4
          }
        }">
      </map-directions-renderer>
    </google-map>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">

    <!-- Route Info Summary -->
    <div class="route-info-card" *ngIf="routeInfo">
      <h3>Route Summary</h3>
      <div class="route-stats">
        <div class="stat">
          <i class="icon-distance"></i>
          <span class="label">Total Distance</span>
          <span class="value">{{ routeInfo.totalDistance / 1000 | number:'1.1-1' }} km</span>
        </div>
        <div class="stat">
          <i class="icon-time"></i>
          <span class="label">Total Duration</span>
          <span class="value">{{ routeInfo.totalDuration }} minutes</span>
        </div>
        <div class="stat">
          <i class="icon-check"></i>
          <span class="label">Status</span>
          <span class="value" [class.valid]="routeInfo.isValid" [class.invalid]="!routeInfo.isValid">
            {{ routeInfo.isValid ? 'Valid' : 'Invalid' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Add Stop Section -->
    <div class="add-stop-section" *ngIf="!readonly">
      <button
        class="btn-add-stop"
        (click)="addStop()"
        *ngIf="!showAddStopForm"
        [disabled]="isValidating">
        <span class="icon">+</span>
        Add Stop
      </button>

      <!-- Search Form -->
      <div class="search-form" *ngIf="showAddStopForm">
        <div class="search-input-wrapper">
          <input
            type="text"
            class="search-input"
            [(ngModel)]="searchQuery"
            (input)="searchPlaces()"
            placeholder="Search for a location..."
            [disabled]="isValidating">
          <button class="btn-cancel" (click)="cancelAdd()">Cancel</button>
        </div>

        <!-- Search Results -->
        <div class="search-results" *ngIf="searchResults.length > 0">
          <div
            class="search-result-item"
            *ngFor="let place of searchResults"
            (click)="selectPlace(place)">
            <i class="icon-location"></i>
            <div class="result-details">
              <div class="result-name">{{ place.structured_formatting?.main_text }}</div>
              <div class="result-address">{{ place.structured_formatting?.secondary_text }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stops List -->
    <div class="stops-list" [formGroup]="stopsForm">
      <h3>Itinerary Stops ({{ stops.length }})</h3>

      <div class="stops-container" formArrayName="stops">
        <div
          class="stop-item"
          *ngFor="let stop of stops.controls; let i = index"
          [formGroupName]="i">

          <!-- Stop Number Badge -->
          <div class="stop-badge" [class.start]="i === 0" [class.end]="i === stops.length - 1">
            {{ i + 1 }}
          </div>

          <!-- Stop Details -->
          <div class="stop-details">
            <div class="stop-name">{{ stop.value.name }}</div>
            <div class="stop-address">{{ stop.value.address }}</div>
            <div class="stop-meta">
              <span class="stop-type" [class.start]="stop.value.type === 'START'"
                    [class.waypoint]="stop.value.type === 'WAYPOINT'"
                    [class.end]="stop.value.type === 'END'">
                {{ stop.value.type }}
              </span>
              <span class="stop-duration" *ngIf="stop.value.durationMinutes">
                {{ stop.value.durationMinutes }} min
              </span>
            </div>
            <div class="stop-description" *ngIf="stop.value.description">
              {{ stop.value.description }}
            </div>
          </div>

          <!-- Stop Actions -->
          <div class="stop-actions" *ngIf="!readonly">
            <button
              class="btn-icon"
              (click)="moveStopUp(i)"
              [disabled]="i === 0 || isValidating"
              title="Move up">
              ↑
            </button>
            <button
              class="btn-icon"
              (click)="moveStopDown(i)"
              [disabled]="i === stops.length - 1 || isValidating"
              title="Move down">
              ↓
            </button>
            <button
              class="btn-icon btn-remove"
              (click)="removeStop(i)"
              [disabled]="isValidating"
              title="Remove stop">
              ×
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="stops.length === 0">
          <i class="icon-map-empty"></i>
          <p>No stops added yet</p>
          <p class="hint">Click "Add Stop" to start creating your itinerary</p>
        </div>
      </div>
    </div>

    <!-- Validate Button -->
    <div class="validate-section" *ngIf="!readonly && stops.length >= 2">
      <button
        class="btn-validate"
        (click)="validateRoute()"
        [disabled]="isValidating || stops.length < 2">
        <span *ngIf="!isValidating">Validate Route</span>
        <span *ngIf="isValidating">Validating...</span>
      </button>
      <p class="validate-hint" *ngIf="stops.length < 2">
        Add at least 2 stops to validate route
      </p>
    </div>

  </div>
</div>
